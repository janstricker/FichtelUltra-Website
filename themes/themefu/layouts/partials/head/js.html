{{- $jsFiles := resources.Match "js/*.js" }}
{{- /* Detect gallery usage: album resources OR class 'lightbox-image' OR data-lightbox attributes in rendered content
  */
-}}
{{- $hasGallery := or (.Resources.Match "album/*" | len) (in (printf "%s" .Content) "lightbox-image") (in (printf "%s"
  .Content) "data-lightbox")
}}
{{- $header := resources.Get "js/header.js" }}
{{- if $header }}
  {{- if eq hugo.Environment "development" }}
    <script src="{{ $header.RelPermalink }}"></script>
  {{- else }}
    {{- with $header | js.Build (dict "minify" true) | fingerprint }}
      <script
        src="{{ .RelPermalink }}"
        integrity="{{ .Data.Integrity }}"
        crossorigin="anonymous"
        defer
      ></script>
    {{- end }}
  {{- end }}
{{- end }}
{{- range $jsFiles }}
  {{- $name := .Name | lower -}}
  {{- if eq hugo.Environment "development" }}
    {{- with . | js.Build }}
      <script src="{{ .RelPermalink }}"></script>
    {{- end }}
  {{- else }}
    {{- $opts := dict "minify" true }}
    {{- with . | js.Build $opts | fingerprint }}
      {{- if (in $name "lightbox") }}
        {{- if $hasGallery }}
          <script
            src="{{ .RelPermalink }}"
            integrity="{{- .Data.Integrity }}"
            crossorigin="anonymous"
            defer
          ></script>
        {{- end }}
      {{- else }}
        <script
          src="{{ .RelPermalink }}"
          integrity="{{- .Data.Integrity }}"
          crossorigin="anonymous"
          defer
        ></script>
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
